<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›™äº‹æ¥­ç®¡ç†ç³»çµ± - é¦¬å¡é¾é¢¨æ ¼</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* é¦¬å¡é¾è‰²ç³»é…è‰² */
        :root {
            --macaron-pink: #FFD6E8;
            --macaron-lavender: #E8D5FF;
            --macaron-mint: #D5FFE8;
            --macaron-peach: #FFE5D5;
            --macaron-sky: #D5E8FF;
            --macaron-lemon: #FFFAD5;
            --macaron-coral: #FFB3B3;
            --macaron-sage: #B3D9B3;
            --text-primary: #5A5A5A;
            --text-secondary: #8A8A8A;
            --white: #FFFFFF;
            --shadow: rgba(0, 0, 0, 0.08);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--macaron-mint) 0%, var(--macaron-sky) 50%, var(--macaron-lavender) 100%);
            min-height: 100vh;
            color: var(--text-primary);
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* å¡ç‰‡æ¨£å¼ */
        .card {
            background: var(--white);
            border-radius: 24px;
            box-shadow: 0 8px 32px var(--shadow);
            margin-bottom: 24px;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .card-header {
            padding: 32px;
            background: linear-gradient(135deg, var(--macaron-lavender), var(--macaron-pink));
            text-align: center;
        }

        .card-body {
            padding: 24px;
        }

        /* æ¨™é¡Œæ¨£å¼ */
        .main-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 24px;
            letter-spacing: -0.5px;
        }

        .section-title {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 16px var(--shadow);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px var(--shadow);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--macaron-lavender), var(--macaron-pink));
            color: var(--text-primary);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--macaron-mint), var(--macaron-sage));
            color: var(--text-primary);
        }

        .btn-info {
            background: linear-gradient(135deg, var(--macaron-sky), var(--macaron-mint));
            color: var(--text-primary);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--macaron-peach), var(--macaron-lemon));
            color: var(--text-primary);
        }

        .btn-coral {
            background: linear-gradient(135deg, var(--macaron-coral), var(--macaron-peach));
            color: var(--text-primary);
        }

        /* å°èˆªæŒ‰éˆ• */
        .nav-buttons {
            display: flex;
            justify-content: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .business-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .view-nav {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* çµ±è¨ˆå¡ç‰‡ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--white);
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 6px 24px var(--shadow);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, var(--macaron-pink), var(--macaron-lavender));
        }

        .stat-value {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 8px 0;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* è¡¨å–®æ¨£å¼ */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .form-control {
            padding: 12px 16px;
            border: 2px solid transparent;
            border-radius: 12px;
            font-size: 14px;
            background: var(--macaron-lemon);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--macaron-lavender);
            background: var(--white);
            box-shadow: 0 0 0 4px rgba(232, 213, 255, 0.3);
        }

        /* è¡¨æ ¼æ¨£å¼ */
        .table-container {
            overflow-x: auto;
            border-radius: 16px;
            box-shadow: 0 4px 20px var(--shadow);
            margin-top: 20px;
        }

        .table {
            width: 100%;
            min-width: 800px;
            border-collapse: collapse;
            background: var(--white);
        }

        .table th {
            background: linear-gradient(135deg, var(--macaron-lavender), var(--macaron-pink));
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
            border: none;
            font-size: 12px;
            white-space: nowrap;
        }

        .table td {
            padding: 12px 8px;
            border-bottom: 1px solid var(--macaron-lemon);
            vertical-align: middle;
            font-size: 13px;
        }

        .table tr:hover {
            background: var(--macaron-lemon);
        }

        /* äº¤æ˜“é …ç›®æ¨£å¼ */
        .transaction-item {
            background: var(--white);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 12px;
            box-shadow: 0 4px 16px var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            border-left: 4px solid var(--macaron-mint);
        }

        .transaction-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px var(--shadow);
        }

        .transaction-item.income {
            border-left-color: var(--macaron-mint);
            background: linear-gradient(135deg, var(--white), var(--macaron-mint));
        }

        .transaction-item.expense {
            border-left-color: var(--macaron-coral);
            background: linear-gradient(135deg, var(--white), var(--macaron-peach));
        }

        .transaction-item.internal {
            border-left-color: var(--macaron-sky);
            background: linear-gradient(135deg, var(--white), var(--macaron-sky));
        }

        .transaction-item.external {
            border-left-color: var(--macaron-lavender);
            background: linear-gradient(135deg, var(--white), var(--macaron-lavender));
        }

        /* å…¥å¸³ç‹€æ…‹æ¨£å¼ */
        .accounting-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-recorded {
            background: var(--macaron-mint);
            color: var(--text-primary);
        }

        .status-pending {
            background: var(--macaron-peach);
            color: var(--text-primary);
        }

        /* æ¨™ç±¤æ¨£å¼ */
        .tag {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .tag-income {
            background: var(--macaron-mint);
            color: var(--text-primary);
        }

        .tag-expense {
            background: var(--macaron-coral);
            color: var(--text-primary);
        }

        .tag-internal {
            background: var(--macaron-sky);
            color: var(--text-primary);
        }

        .tag-external {
            background: var(--macaron-lavender);
            color: var(--text-primary);
        }

        /* å°ç£é’å¹´å“ç‰Œæ¨™ç±¤ */
        .brand-taiwan-youth {
            background: linear-gradient(135deg, #FF6B6B, #4ECDC4);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }

        /* å·¥å…·åˆ— */
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }

        /* éš±è—/é¡¯ç¤ºå…ƒç´  */
        .hidden {
            display: none;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
                grid-column: span 1;
            }
            
            .nav-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .business-nav {
                flex-direction: column;
                gap: 16px;
                text-align: center;
            }
        }

        /* å‹•ç•«æ•ˆæœ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        /* è¡¨å–®å€åŸŸæ¨£å¼ */
        .form-section {
            background: linear-gradient(135deg, var(--macaron-lemon), var(--macaron-mint));
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .form-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 20px;
            text-align: center;
        }

        /* é‡‘é¡é¡¯ç¤ºæ¨£å¼ */
        .amount-positive {
            color: #059669;
            font-weight: 700;
        }

        .amount-negative {
            color: #DC2626;
            font-weight: 700;
        }

        .amount-display {
            font-size: 1.1rem;
            font-weight: 600;
        }

        /* å¹´åº¦çµ±è¨ˆå®¹å™¨ */
        .yearly-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }

        /* ç™¼ç¥¨åŠŸèƒ½æ¨£å¼ */
        .invoice-info {
            display: inline-flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .invoice-number {
            background: var(--macaron-sky);
            color: var(--text-primary);
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 600;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            grid-column: span 2;
        }

        .btn-toggle {
            background: var(--macaron-mint);
            border: 2px solid var(--macaron-sage);
            color: var(--text-primary);
        }

        .btn-toggle.pending {
            background: var(--macaron-peach);
            border-color: var(--macaron-coral);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ä¸»æ¨™é¡Œå¡ç‰‡ -->
        <div class="card">
            <div class="card-header">
                <h1 class="main-title">ğŸ¨ é›™äº‹æ¥­ç®¡ç†ç³»çµ±</h1>
                <div class="nav-buttons">
                    <button class="btn btn-primary" onclick="switchBusiness('studio')">
                        ğŸ“¸ æ”å½±å·¥ä½œå®¤
                    </button>
                    <button class="btn btn-success" onclick="switchBusiness('craft')">
                        ğŸ¨ æ‰‹å·¥è—å“äº‹æ¥­
                    </button>
                    <button class="btn btn-coral" onclick="clearAllData()">
                        ğŸ—‘ï¸ æ¸…é™¤è³‡æ–™
                    </button>
                </div>
            </div>
        </div>

        <!-- æ”å½±å·¥ä½œå®¤å€åŸŸ -->
        <div id="studio-section" class="hidden">
            <div class="card">
                <div class="card-body">
                    <div class="business-nav">
                        <h2 class="section-title">ğŸ“¸ æ”å½±å·¥ä½œå®¤ç®¡ç†</h2>
                        <div class="view-nav">
                            <button class="btn btn-info" onclick="switchView('studio', 'dashboard')">ğŸ“Š è²¡å‹™æ¦‚æ³</button>
                            <button class="btn btn-warning" onclick="switchView('studio', 'internal')">ğŸ¢ å…§å¸³ç®¡ç†</button>
                            <button class="btn btn-primary" onclick="switchView('studio', 'external')">ğŸ’¼ å¤–å¸³ç®¡ç†</button>
                            <button class="btn btn-success" onclick="switchView('studio', 'monthly')">ğŸ“ˆ æœˆå ±è¡¨</button>
                            <button class="btn btn-success" onclick="switchView('studio', 'yearly')">ğŸ“… å¹´åº¦ç¸½è¡¨</button>
                            <button class="btn btn-coral" onclick="exportToExcel('studio')">ğŸ“„ åŒ¯å‡ºExcel</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ”å½±å·¥ä½œå®¤å„€è¡¨æ¿ -->
            <div id="studio-dashboard" class="fade-in">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">æœ¬æœˆå…§å¸³æ”¯å‡º</div>
                        <div class="stat-value amount-negative" id="studio-monthly-internal">NT$ 0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">æœ¬æœˆå¤–å¸³æ”¶å…¥</div>
                        <div class="stat-value amount-positive" id="studio-monthly-external-income">NT$ 0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">æœ¬æœˆå¤–å¸³æ”¯å‡º</div>
                        <div class="stat-value amount-negative" id="studio-monthly-external-expense">NT$ 0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">æœ¬æœˆæ·¨åˆ©</div>
                        <div class="stat-value" id="studio-monthly-profit">NT$ 0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">å¾…å…¥å¸³é‡‘é¡</div>
                        <div class="stat-value amount-negative" id="studio-pending-amount">NT$ 0</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <h3 class="section-title">ğŸ“ˆ æœ€è¿‘äº¤æ˜“è¨˜éŒ„</h3>
                        <div id="studio-recent-transactions"></div>
                    </div>
                </div>
            </div>

            <!-- æ”å½±å·¥ä½œå®¤å…§å¸³ç®¡ç† -->
            <div id="studio-internal" class="hidden">
                <div class="card">
                    <div class="card-body">
                        <div class="toolbar">
                            <h3 class="section-title">ğŸ¢ å…§å¸³ç®¡ç† (å·¥ä½œå®¤æ”¯å‡º)</h3>
                            <button class="btn btn-primary" onclick="toggleForm('studio-internal-form')">
                                â• æ–°å¢å…§å¸³è¨˜éŒ„
                            </button>
                        </div>

                        <div id="studio-internal-form" class="form-section hidden">
    <h4 class="form-title">æ–°å¢æ”å½±å·¥ä½œå®¤å…§å¸³è¨˜éŒ„</h4>
    <div class="form-grid">
        <select id="studio-internal-type" class="form-control">
            <option value="expense">å…§å¸³æ”¯å‡º</option>
            <option value="income">å…§å¸³æ”¶å…¥</option>
        </select>
        
        <select id="studio-internal-account" class="form-control">
            <option value="">é¸æ“‡æœƒè¨ˆç§‘ç›®</option>
        </select>
        <input type="number" id="studio-internal-amount" class="form-control" placeholder="é‡‘é¡">
        <input type="text" id="studio-internal-description" class="form-control" placeholder="è©³ç´°æè¿°">
        <input type="date" id="studio-internal-date" class="form-control" title="äº¤æ˜“æ—¥æœŸ">
        
        <input type="text" id="studio-internal-invoice" class="form-control" placeholder="ç™¼ç¥¨è™Ÿç¢¼ (é¸å¡«)">
        <input type="date" id="studio-internal-invoice-date" class="form-control" title="ç™¼ç¥¨æ—¥æœŸ (é¸å¡«)">
        
        <button type="button" id="studio-internal-status-toggle" class="btn btn-toggle" onclick="toggleAccountingStatus('studio-internal')">
            <span id="studio-internal-status-text">å·²å…¥å¸³</span>
        </button>
        
        <button class="btn btn-success" onclick="addTransaction('studio', 'internal')">æ–°å¢è¨˜éŒ„</button>
    </div>
</div>

                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
        <th>äº¤æ˜“æ—¥æœŸ</th>
        <th>é¡å‹</th>
        <th>æœƒè¨ˆç§‘ç›®</th>
        <th>æ‘˜è¦èªªæ˜</th>
        <th>æ”¶å…¥</th>
        <th>æ”¯å‡º</th>
        <th>ç™¼ç¥¨è³‡è¨Š</th>
        <th>å…¥å¸³ç‹€æ…‹</th>
        <th>æ“ä½œ</th>
    </tr>
</thead>
                                <tbody id="studio-internal-table"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ”å½±å·¥ä½œå®¤å¤–å¸³ç®¡ç† -->
            <div id="studio-external" class="hidden">
                <div class="card">
                    <div class="card-body">
                        <div class="toolbar">
                            <h3 class="section-title">ğŸ’¼ å¤–å¸³ç®¡ç† (ç‡Ÿæ¥­æ”¶æ”¯)</h3>
                            <button class="btn btn-primary" onclick="toggleForm('studio-external-form')">
                                â• æ–°å¢å¤–å¸³è¨˜éŒ„
                            </button>
                        </div>

                        <div id="studio-external-form" class="form-section hidden">
                            <h4 class="form-title">æ–°å¢æ”å½±å·¥ä½œå®¤å¤–å¸³è¨˜éŒ„</h4>
                            <div class="form-grid">
                                <select id="studio-external-type" class="form-control">
                                    <option value="income">ç‡Ÿæ¥­æ”¶å…¥</option>
                                    <option value="expense">ç‡Ÿæ¥­æ”¯å‡º</option>
                                </select>
                                <select id="studio-external-account" class="form-control">
                                    <option value="">é¸æ“‡æœƒè¨ˆç§‘ç›®</option>
                                </select>
                                <input type="number" id="studio-external-amount" class="form-control" placeholder="é‡‘é¡">
                                <input type="text" id="studio-external-description" class="form-control" placeholder="è©³ç´°æè¿°">
                                <input type="date" id="studio-external-date" class="form-control" title="äº¤æ˜“æ—¥æœŸ">
                                
                                <!-- ç™¼ç¥¨ç›¸é—œæ¬„ä½ -->
                                <input type="text" id="studio-external-invoice" class="form-control" placeholder="ç™¼ç¥¨è™Ÿç¢¼ (é¸å¡«)">
                                <input type="date" id="studio-external-invoice-date" class="form-control" title="ç™¼ç¥¨æ—¥æœŸ (é¸å¡«)">
                                
                                <button type="button" id="studio-external-status-toggle" class="btn btn-toggle" onclick="toggleAccountingStatus('studio-external')">
                                    <span id="studio-external-status-text">å·²å…¥å¸³</span>
                                </button>
                                
                                <button class="btn btn-success" onclick="addTransaction('studio', 'external')">æ–°å¢è¨˜éŒ„</button>
                            </div>
                        </div>

                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>äº¤æ˜“æ—¥æœŸ</th>
                                        <th>é¡å‹</th>
                                        <th>æœƒè¨ˆç§‘ç›®</th>
                                        <th>æ‘˜è¦èªªæ˜</th>
                                        <th>æ”¶å…¥</th>
                                        <th>æ”¯å‡º</th>
                                        <th>ç™¼ç¥¨è³‡è¨Š</th>
                                        <th>å…¥å¸³ç‹€æ…‹</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="studio-external-table"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ”å½±å·¥ä½œå®¤æœˆå ±è¡¨ -->
            <div id="studio-monthly" class="hidden">
                <div class="card">
                    <div class="card-body">
                        <div class="toolbar">
                            <h3 class="section-title">ğŸ“ˆ æ”å½±å·¥ä½œå®¤æœˆå ±è¡¨</h3>
                            <div style="display: flex; gap: 12px; align-items: center;">
                                <input type="month" id="studio-month-selector" class="form-control" style="width: auto;" onchange="updateMonthlyReport('studio')">
                                <button class="btn btn-coral" onclick="exportMonthlyToExcel('studio')">ğŸ“„ åŒ¯å‡ºæœˆå ±è¡¨</button>
                            </div>
                        </div>

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-label">æœˆåº¦å…§å¸³æ”¯å‡º</div>
        <div class="stat-value amount-negative" id="studio-report-internal-expense">NT$ 0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">æœˆåº¦å…§å¸³æ”¶å…¥</div>
        <div class="stat-value amount-positive" id="studio-report-internal-income">NT$ 0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">æœˆåº¦å¤–å¸³æ”¶å…¥</div>
        <div class="stat-value amount-positive" id="studio-report-external-income">NT$ 0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">æœˆåº¦å¤–å¸³æ”¯å‡º</div>
        <div class="stat-value amount-negative" id="studio-report-external-expense">NT$ 0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">æœˆåº¦æ·¨åˆ©</div>
        <div class="stat-value" id="studio-report-profit">NT$ 0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">å·²å…¥å¸³äº¤æ˜“</div>
        <div class="stat-value" id="studio-report-recorded">0 ç­†</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">å¾…å…¥å¸³äº¤æ˜“</div>
        <div class="stat-value amount-negative" id="studio-report-pending">0 ç­†</div>
    </div>
</div>

                        <div class="card">
                            <div class="card-body">
                                <h4 class="section-title">ğŸ“‹ æœˆåº¦äº¤æ˜“æ˜ç´°</h4>
                                <div id="studio-monthly-details"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ”å½±å·¥ä½œå®¤å¹´åº¦ç¸½è¡¨ -->
            <div id="studio-yearly" class="hidden">
                <div class="card">
                    <div class="card-body">
                        <h3 class="section-title">ğŸ“… æ”å½±å·¥ä½œå®¤å¹´åº¦ç¸½è¡¨</h3>
                        <div class="yearly-stats">
    <div class="stat-card">
        <div class="stat-label">å¹´åº¦ç‡Ÿæ¥­æ”¶å…¥</div>
        <div class="stat-value amount-positive" id="studio-yearly-external-income">NT$ 0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">å¹´åº¦ç‡Ÿæ¥­æ”¯å‡º</div>
        <div class="stat-value amount-negative" id="studio-yearly-external-expense">NT$ 0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">å¹´åº¦å…§å¸³æ”¶å…¥</div>
        <div class="stat-value amount-positive" id="studio-yearly-internal-income">NT$ 0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">å¹´åº¦å…§å¸³æ”¯å‡º</div>
        <div class="stat-value amount-negative" id="studio-yearly-internal-expense">NT$ 0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">å¹´åº¦æ·¨åˆ©</div>
        <div class="stat-value" id="studio-yearly-profit">NT$ 0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">å¹´åº¦å¾…å…¥å¸³</div>
        <div class="stat-value amount-negative" id="studio-yearly-pending">NT$ 0</div>
    </div>
</div>

        <!-- æ‰‹å·¥è—å“äº‹æ¥­å€åŸŸ -->
        <div id="craft-section" class="hidden">
            <div class="card">
                <div class="card-body">
                    <div class="business-nav">
                        <h2 class="section-title">ğŸ¨ æ‰‹å·¥è—å“äº‹æ¥­ç®¡ç†</h2>
                        <div class="view-nav">
                            <button class="btn btn-info" onclick="switchView('craft', 'dashboard')">ğŸ“Š ç‡Ÿé‹æ¦‚æ³</button>
                            <button class="btn btn-warning" onclick="switchView('craft', 'internal')">ğŸ¢ å…§å¸³ç®¡ç†</button>
                            <button class="btn btn-primary" onclick="switchView('craft', 'external')">ğŸ’¼ å¤–å¸³ç®¡ç†</button>
                            <button class="btn btn-success" onclick="switchView('craft', 'inventory')">ğŸ“¦ åº«å­˜ç®¡ç†</button>
                            <button class="btn btn-success" onclick="switchView('craft', 'monthly')">ğŸ“ˆ æœˆå ±è¡¨</button>
                            <button class="btn btn-success" onclick="switchView('craft', 'yearly')">ğŸ“… å¹´åº¦ç¸½è¡¨</button>
                            <button class="btn btn-coral" onclick="exportToExcel('craft')">ğŸ“„ åŒ¯å‡ºExcel</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ‰‹å·¥è—å“å„€è¡¨æ¿ -->
            <div id="craft-dashboard" class="fade-in">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">æœ¬æœˆå…§å¸³æ”¯å‡º</div>
                        <div class="stat-value amount-negative" id="craft-monthly-internal">NT$ 0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">æœ¬æœˆå¤–å¸³æ”¶å…¥</div>
                        <div class="stat-value amount-positive" id="craft-monthly-external-income">NT$ 0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">æœ¬æœˆå¤–å¸³æ”¯å‡º</div>
                        <div class="stat-value amount-negative" id="craft-monthly-external-expense">NT$ 0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">æœ¬æœˆæ·¨åˆ©</div>
                        <div class="stat-value" id="craft-monthly-profit">NT$ 0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">åº«å­˜ç¸½å€¼</div>
                        <div class="stat-value" id="craft-inventory-value">NT$ 0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">å°ç£é’å¹´å•†å“ç¸½å€¼</div>
                        <div class="stat-value" id="craft-taiwan-youth-value">NT$ 0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">å¾…å…¥å¸³é‡‘é¡</div>
                        <div class="stat-value amount-negative" id="craft-pending-amount">NT$ 0</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <h3 class="section-title">ğŸ›ï¸ æœ€è¿‘äº¤æ˜“è¨˜éŒ„</h3>
                        <div id="craft-recent-transactions"></div>
                    </div>
                </div>
            </div>

            <!-- æ‰‹å·¥è—å“å…§å¸³ç®¡ç† -->
            <div id="craft-internal" class="hidden">
                <div class="card">
                    <div class="card-body">
                        <div class="toolbar">
                            <h3 class="section-title">ğŸ¢ å…§å¸³ç®¡ç† (å·¥ä½œå®¤æ”¯å‡º)</h3>
                            <button class="btn btn-primary" onclick="toggleForm('craft-internal-form')">
                                â• æ–°å¢å…§å¸³è¨˜éŒ„
                            </button>
                        </div>

                        <div id="craft-internal-form" class="form-section hidden">
                            <h4 class="form-title">æ–°å¢æ‰‹å·¥è—å“å…§å¸³è¨˜éŒ„</h4>
                            <div class="form-grid">
                                <select id="craft-internal-account" class="form-control">
                                    <option value="">é¸æ“‡æœƒè¨ˆç§‘ç›®</option>
                                </select>
                                <input type="number" id="craft-internal-amount" class="form-control" placeholder="é‡‘é¡">
                                <input type="text" id="craft-internal-description" class="form-control" placeholder="è©³ç´°æè¿°">
                                <input type="date" id="craft-internal-date" class="form-control" title="äº¤æ˜“æ—¥æœŸ">
                                
                                <!-- ç™¼ç¥¨ç›¸é—œæ¬„ä½ -->
                                <input type="text" id="craft-internal-invoice" class="form-control" placeholder="ç™¼ç¥¨è™Ÿç¢¼ (é¸å¡«)">
                                <input type="date" id="craft-internal-invoice-date" class="form-control" title="ç™¼ç¥¨æ—¥æœŸ (é¸å¡«)">
                                
                                <button type="button" id="craft-internal-status-toggle" class="btn btn-toggle" onclick="toggleAccountingStatus('craft-internal')">
                                    <span id="craft-internal-status-text">å·²å…¥å¸³</span>
                                </button>
                                
                                <button class="btn btn-success" onclick="addTransaction('craft', 'internal')">æ–°å¢è¨˜éŒ„</button>
                            </div>
                        </div>

                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>äº¤æ˜“æ—¥æœŸ</th>
                                        <th>æœƒè¨ˆç§‘ç›®</th>
                                        <th>æ‘˜è¦èªªæ˜</th>
                                        <th>é‡‘é¡</th>
                                        <th>ç™¼ç¥¨è³‡è¨Š</th>
                                        <th>å…¥å¸³ç‹€æ…‹</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="craft-internal-table"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ‰‹å·¥è—å“å¤–å¸³ç®¡ç† -->
            <div id="craft-external" class="hidden">
                <div class="card">
                    <div class="card-body">
                        <div class="toolbar">
                            <h3 class="section-title">ğŸ’¼ å¤–å¸³ç®¡ç† (ç‡Ÿæ¥­æ”¶æ”¯)</h3>
                            <button class="btn btn-primary" onclick="toggleForm('craft-external-form')">
                                â• æ–°å¢å¤–å¸³è¨˜éŒ„
                            </button>
                        </div>

                        <div id="craft-external-form" class="form-section hidden">
                            <h4 class="form-title">æ–°å¢æ‰‹å·¥è—å“å¤–å¸³è¨˜éŒ„</h4>
                            <div class="form-grid">
                                <select id="craft-external-type" class="form-control">
                                    <option value="income">ç‡Ÿæ¥­æ”¶å…¥</option>
                                    <option value="expense">ç‡Ÿæ¥­æ”¯å‡º</option>
                                </select>
                                <select id="craft-external-account" class="form-control">
                                    <option value="">é¸æ“‡æœƒè¨ˆç§‘ç›®</option>
                                </select>
                                <input type="number" id="craft-external-amount" class="form-control" placeholder="é‡‘é¡">
                                <input type="text" id="craft-external-description" class="form-control" placeholder="è©³ç´°æè¿°">
                                <select id="craft-external-brand" class="form-control">
                                    <option value="">é¸æ“‡å“ç‰Œ</option>
                                    <option value="å°ç£é’å¹´">å°ç£é’å¹´</option>
                                    <option value="å…¶ä»–">å…¶ä»–å“ç‰Œ</option>
                                </select>
                                <input type="date" id="craft-external-date" class="form-control" title="äº¤æ˜“æ—¥æœŸ">
                                
                                <!-- ç™¼ç¥¨ç›¸é—œæ¬„ä½ -->
                                <input type="text" id="craft-external-invoice" class="form-control" placeholder="ç™¼ç¥¨è™Ÿç¢¼ (é¸å¡«)">
                                <input type="date" id="craft-external-invoice-date" class="form-control" title="ç™¼ç¥¨æ—¥æœŸ (é¸å¡«)">
                                
                                <button type="button" id="craft-external-status-toggle" class="btn btn-toggle" onclick="toggleAccountingStatus('craft-external')">
                                    <span id="craft-external-status-text">å·²å…¥å¸³</span>
                                </button>
                                
                                <button class="btn btn-success" onclick="addTransaction('craft', 'external')">æ–°å¢è¨˜éŒ„</button>
                            </div>
                        </div>

                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>äº¤æ˜“æ—¥æœŸ</th>
                                        <th>é¡å‹</th>
                                        <th>æœƒè¨ˆç§‘ç›®</th>
                                        <th>æ‘˜è¦èªªæ˜</th>
                                        <th>å“ç‰Œ</th>
                                        <th>æ”¶å…¥</th>
                                        <th>æ”¯å‡º</th>
                                        <th>ç™¼ç¥¨è³‡è¨Š</th>
                                        <th>å…¥å¸³ç‹€æ…‹</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="craft-external-table"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

<div id="craft-inventory" class="hidden">
    <div class="card">
        <div class="card-body">
            <div class="toolbar">
                <h3 class="section-title">ğŸ“¦ åº«å­˜ç®¡ç†</h3>
                <button class="btn btn-primary" onclick="toggleForm('inventory-form')">
                    â• æ–°å¢å•†å“
                </button>
            </div>

            <div id="inventory-form" class="form-section hidden">
                <h4 class="form-title">æ–°å¢åº«å­˜å•†å“</h4>
                <div class="form-grid">
                    
             <select id="inventory-brand" class="form-control">
                        <option value="">é¸æ“‡å“ç‰Œ</option>
                        <option value="å°ç£é’å¹´">å°ç£é’å¹´</option>
                        <option value="å…¶ä»–">å…¶ä»–å“ç‰Œ</option>
                    </select>
                    <select id="inventory-category" class="form-control">
                        <option value="">é¸æ“‡å•†å“é¡åˆ¥</option>
                        <option value="è¡£æœ">è¡£æœ</option>
                        <option value="åŠé£¾">åŠé£¾</option>
                        <option value="æ‰‹å·¥é£¾å“">æ‰‹å·¥é£¾å“</option>
                        <option value="ç”Ÿæ´»ç”¨å“">ç”Ÿæ´»ç”¨å“</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                    <input type="text" id="inventory-name" class="form-control" placeholder="å•†å“åç¨±">
                    <input type="number" id="inventory-cost" class="form-control" placeholder="æˆæœ¬">
                    <input type="number" id="inventory-price" class="form-control" placeholder="å”®åƒ¹">
                    <input type="number" id="inventory-quantity" class="form-control" placeholder="æ•¸é‡">
                    <input type="text" id="inventory-notes" class="form-control" placeholder="å‚™è¨»">
                    <button class="btn btn-success" onclick="addInventoryItem()">æ–°å¢å•†å“</button>
                </div>
            </div>

            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>å“ç‰Œ</th>
                            <th>é¡åˆ¥</th>
                            <th>å•†å“åç¨±</th>
                            <th>æˆæœ¬</th>
                            <th>å”®åƒ¹</th>
                            <th>åº«å­˜é‡</th>
                            <th>åº«å­˜åƒ¹å€¼</th>
                            <th>å‚™è¨»</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="craft-inventory-table"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

            <!-- æ‰‹å·¥è—å“æœˆå ±è¡¨ -->
            <div id="craft-monthly" class="hidden">
                <div class="card">
                    <div class="card-body">
                        <div class="toolbar">
                            <h3 class="section-title">ğŸ“ˆ æ‰‹å·¥è—å“äº‹æ¥­æœˆå ±è¡¨</h3>
                            <div style="display: flex; gap: 12px; align-items: center;">
                                <input type="month" id="craft-month-selector" class="form-control" style="width: auto;" onchange="updateMonthlyReport('craft')">
                                <button class="btn btn-coral" onclick="exportMonthlyToExcel('craft')">ğŸ“„ åŒ¯å‡ºæœˆå ±è¡¨</button>
                            </div>
                        </div>

                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-label">æœˆåº¦å…§å¸³æ”¯å‡º</div>
                                <div class="stat-value amount-negative" id="craft-report-internal">NT$ 0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">æœˆåº¦å¤–å¸³æ”¶å…¥</div>
                                <div class="stat-value amount-positive" id="craft-report-income">NT$ 0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">æœˆåº¦å¤–å¸³æ”¯å‡º</div>
                                <div class="stat-value amount-negative" id="craft-report-expense">NT$ 0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">æœˆåº¦æ·¨åˆ©</div>
                                <div class="stat-value" id="craft-report-profit">NT$ 0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">å°ç£é’å¹´éŠ·å”®</div>
                                <div class="stat-value" id="craft-report-taiwan-youth">NT$ 0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">å·²å…¥å¸³äº¤æ˜“</div>
                                <div class="stat-value" id="craft-report-recorded">0 ç­†</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">å¾…å…¥å¸³äº¤æ˜“</div>
                                <div class="stat-value amount-negative" id="craft-report-pending">0 ç­†</div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-body">
                                <h4 class="section-title">ğŸ“‹ æœˆåº¦äº¤æ˜“æ˜ç´°</h4>
                                <div id="craft-monthly-details"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ‰‹å·¥è—å“å¹´åº¦ç¸½è¡¨ -->
            <div id="craft-yearly" class="hidden">
                <div class="card">
                    <div class="card-body">
                        <h3 class="section-title">ğŸ“… æ‰‹å·¥è—å“äº‹æ¥­å¹´åº¦ç¸½è¡¨</h3>
                        <div class="yearly-stats">
                            <div class="stat-card">
                                <div class="stat-label">å¹´åº¦ç‡Ÿæ¥­æ”¶å…¥</div>
                                <div class="stat-value amount-positive" id="craft-yearly-income">NT$ 0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">å¹´åº¦ç‡Ÿæ¥­æ”¯å‡º</div>
                                <div class="stat-value amount-negative" id="craft-yearly-expense">NT$ 0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">å¹´åº¦å…§å¸³æ”¯å‡º</div>
                                <div class="stat-value amount-negative" id="craft-yearly-internal">NT$ 0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">å°ç£é’å¹´éŠ·å”®é¡</div>
                                <div class="stat-value" id="craft-taiwan-youth-sales">NT$ 0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">å¹´åº¦å¾…å…¥å¸³</div>
                                <div class="stat-value amount-negative" id="craft-yearly-pending">NT$ 0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // è³‡æ–™å„²å­˜çµæ§‹
        let businessData = {
            studio: {
                internal: [],
                external: []
            },
            craft: {
                internal: [],
                external: [],
                inventory: []
            }
        };

        // æœƒè¨ˆç§‘ç›®è¨­å®š
        const accounts = {
            studio: {
                internal: [
                    'ç§Ÿé‡‘æ”¯å‡º', 'æ°´é›»è²»ç”¨', 'ç¶²è·¯è²»ç”¨', 'æ¸…æ½”è²»ç”¨', 'è¨­å‚™ç¶­è­·è²»', 
                    'å…¬å…±è¨­æ–½ä½¿ç”¨è²»', 'ç®¡ç†è²»ç”¨', 'ä¿éšªè²»ç”¨', 'å…¶ä»–å…±åŒæ”¯å‡º'
                ],
                external: {
                    income: [
                        'æ”å½±æœå‹™æ”¶å…¥', 'å©šç¦®æ”å½±æ”¶å…¥', 'å•†æ¥­æ”å½±æ”¶å…¥', 'äººåƒæ”å½±æ”¶å…¥', 
                        'æ´»å‹•æ”å½±æ”¶å…¥', 'å½±ç‰‡è£½ä½œæ”¶å…¥', 'å¾Œè£½æœå‹™æ”¶å…¥', 'å™¨æç§Ÿå€Ÿæ”¶å…¥', 'å…¶ä»–ç‡Ÿæ¥­æ”¶å…¥'
                    ],
                    expense: [
                        'è¨­å‚™è²»ç”¨', 'å™¨ææŠ˜èˆŠ', 'ç¶­ä¿®è²»ç”¨', 'äº¤é€šè²»ç”¨', 'è¡ŒéŠ·è²»ç”¨', 
                        'è¾¦å…¬è²»ç”¨', 'è»Ÿé«”æˆæ¬Šè²»', 'éŠ€è¡Œæ‰‹çºŒè²»', 'ç¨…å‹™è²»ç”¨', 'å…¶ä»–ç‡Ÿæ¥­è²»ç”¨'
                    ]
                }
            },
            craft: {
                internal: [
                    'ç§Ÿé‡‘æ”¯å‡º', 'æ°´é›»è²»ç”¨', 'ç¶²è·¯è²»ç”¨', 'å·¥å…·è¨­å‚™è²»', 'ç¶­ä¿®ä¿é¤Šè²»',
                    'ä¿éšªè²»ç”¨', 'å…¶ä»–å·¥ä½œå®¤è²»ç”¨'
                ],
                external: {
                    income: [
                        'å•†å“éŠ·å”®æ”¶å…¥', 'æ‰‹å·¥é£¾å“æ”¶å…¥', 'æœé£¾éŠ·å”®æ”¶å…¥', 'ç”Ÿæ´»ç”¨å“æ”¶å…¥', 
                        'å®¢è£½åŒ–æ”¶å…¥', 'æ•™å­¸æ”¶å…¥', 'å…¶ä»–ç‡Ÿæ¥­æ”¶å…¥'
                    ],
                    expense: [
                        'åŸæ–™æˆæœ¬', 'åŒ…è£ææ–™è²»', 'é‹è²»æ”¯å‡º', 'è¡ŒéŠ·è²»ç”¨', 
                        'å¸‚å ´æ”¤ä½è²»', 'ç¶²è·¯å¹³å°è²»ç”¨', 'éŠ€è¡Œæ‰‹çºŒè²»', 'å…¶ä»–ç‡Ÿæ¥­è²»ç”¨'
                    ]
                }
            }
        };

        // ç•¶å‰ç‹€æ…‹
        let currentBusiness = '';
        let currentView = '';
        let currentAccountingStatus = { 'studio-internal': 'recorded', 'studio-external': 'recorded', 'craft-internal': 'recorded', 'craft-external': 'recorded' };

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            
            // è¨­å®šä»Šæ—¥æ—¥æœŸ
            const today = new Date().toISOString().split('T')[0];
            const dateInputs = [
                'studio-internal-date', 'studio-external-date',
                'craft-internal-date', 'craft-external-date'
            ];
            
            dateInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.value = today;
            });
            
            // åˆå§‹åŒ–æœƒè¨ˆç§‘ç›®é¸é …
            updateAccountOptions();
            
            // åˆå§‹åŒ–å…¥å¸³ç‹€æ…‹æŒ‰éˆ•
            initializeAccountingStatusButtons();
            
            // é¡¯ç¤ºæ”å½±å·¥ä½œå®¤
            switchBusiness('studio');
        });

        // åˆå§‹åŒ–å…¥å¸³ç‹€æ…‹æŒ‰éˆ•
        function initializeAccountingStatusButtons() {
            const formTypes = ['studio-internal', 'studio-external', 'craft-internal', 'craft-external'];
            formTypes.forEach(type => {
                const toggleBtn = document.getElementById(type + '-status-toggle');
                const textSpan = document.getElementById(type + '-status-text');
                if (toggleBtn && textSpan) {
                    toggleBtn.classList.remove('pending');
                    textSpan.textContent = 'å·²å…¥å¸³';
                }
            });
        }

        // åˆ‡æ›å…¥å¸³ç‹€æ…‹
        function toggleAccountingStatus(formType) {
            const toggleBtn = document.getElementById(formType + '-status-toggle');
            const textSpan = document.getElementById(formType + '-status-text');
            
            if (!toggleBtn || !textSpan) return;
            
            // åˆ‡æ›ç‹€æ…‹
            if (currentAccountingStatus[formType] === 'recorded') {
                // æ”¹æˆå¾…å…¥å¸³
                currentAccountingStatus[formType] = 'pending';
                toggleBtn.classList.add('pending');
                textSpan.textContent = 'å¾…å…¥å¸³';
            } else {
                // æ”¹æˆå·²å…¥å¸³
                currentAccountingStatus[formType] = 'recorded';
                toggleBtn.classList.remove('pending');
                textSpan.textContent = 'å·²å…¥å¸³';
            }
        }

        // è¼‰å…¥è³‡æ–™
        function loadData() {
            const savedData = localStorage.getItem('businessData');
            if (savedData) {
                businessData = JSON.parse(savedData);
                
                // ç¢ºä¿èˆŠè³‡æ–™æœ‰æ–°æ¬„ä½
                ['studio', 'craft'].forEach(business => {
                    ['internal', 'external'].forEach(category => {
                        businessData[business][category].forEach(item => {
                            if (!item.hasOwnProperty('invoiceNumber')) item.invoiceNumber = '';
                            if (!item.hasOwnProperty('invoiceDate')) item.invoiceDate = '';
                            if (!item.hasOwnProperty('accountingStatus')) item.accountingStatus = 'recorded';
                        });
                    });
                });
            } else {
                // é è¨­ç¯„ä¾‹è³‡æ–™
                businessData = {
                    studio: {
                        internal: [
                            { 
                                id: 1, 
                                account: 'ç§Ÿé‡‘æ”¯å‡º', 
                                amount: 15000, 
                                description: '9æœˆä»½å·¥ä½œå®¤ç§Ÿé‡‘', 
                                date: '2025-09-01',
                                invoiceNumber: 'AB12345678',
                                invoiceDate: '2025-09-01',
                                accountingStatus: 'recorded'
                            }
                        ],
                        external: [
                            { 
                                id: 1, 
                                type: 'income', 
                                account: 'æ”å½±æœå‹™æ”¶å…¥', 
                                amount: 35000, 
                                description: 'å¼µå…ˆç”Ÿå©šç¦®æ”å½±æœå‹™', 
                                date: '2025-09-15',
                                invoiceNumber: 'CD87654321',
                                invoiceDate: '2025-09-15',
                                accountingStatus: 'pending'
                            }
                        ]
                    },
                    craft: {
                        internal: [
                            { 
                                id: 1, 
                                account: 'ç§Ÿé‡‘æ”¯å‡º', 
                                amount: 8000, 
                                description: 'å·¥ä½œå®¤ç§Ÿé‡‘åˆ†æ”¤', 
                                date: '2025-09-01',
                                invoiceNumber: '',
                                invoiceDate: '',
                                accountingStatus: 'recorded'
                            }
                        ],
                        external: [
                            { 
                                id: 1, 
                                type: 'income', 
                                account: 'å•†å“éŠ·å”®æ”¶å…¥', 
                                amount: 1200, 
                                description: 'æ‰‹å·¥é«®åœˆéŠ·å”®', 
                                date: '2025-09-16',
                                brand: 'å°ç£é’å¹´',
                                invoiceNumber: 'EF11223344',
                                invoiceDate: '2025-09-16',
                                accountingStatus: 'recorded'
                            }
                        ],
                        inventory: [
                            { 
                                id: 1, 
                                brand: 'å°ç£é’å¹´',  
                                category: 'åŠé£¾',
                                name: 'å¾©å¤é¢¨é«®åœˆ',
                                quantity: 15, 
                                cost: 80, 
                                price: 180,  
                                notes: 'æ‰‹å·¥è£½ä½œ' 
                            }
                        ]
                    }
                };
                saveData();
            }
        }

        // å„²å­˜è³‡æ–™
        function saveData() {
            localStorage.setItem('businessData', JSON.stringify(businessData));
        }

        // æ›´æ–°æœƒè¨ˆç§‘ç›®é¸é …
        function updateAccountOptions() {
            // æ”å½±å·¥ä½œå®¤å…§å¸³
            updateSelectOptions('studio-internal-account', accounts.studio.internal);
            
            // æ”å½±å·¥ä½œå®¤å¤–å¸³
            const studioExternalType = document.getElementById('studio-external-type');
            if (studioExternalType) {
                studioExternalType.addEventListener('change', function() {
                    updateSelectOptions('studio-external-account', accounts.studio.external[this.value]);
                });
            }
            updateSelectOptions('studio-external-account', accounts.studio.external.income);

            // æ‰‹å·¥è—å“å…§å¸³
            updateSelectOptions('craft-internal-account', accounts.craft.internal);
            
            // æ‰‹å·¥è—å“å¤–å¸³
            const craftExternalType = document.getElementById('craft-external-type');
            if (craftExternalType) {
                craftExternalType.addEventListener('change', function() {
                    updateSelectOptions('craft-external-account', accounts.craft.external[this.value]);
                });
            }
            updateSelectOptions('craft-external-account', accounts.craft.external.income);
        }

        function updateSelectOptions(selectId, options) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            select.innerHTML = '<option value="">é¸æ“‡æœƒè¨ˆç§‘ç›®</option>';
            options.forEach(option => {
                select.innerHTML += `<option value="${option}">${option}</option>`;
            });
        }

        // åˆ‡æ›äº‹æ¥­
        function switchBusiness(business) {
            currentBusiness = business;
            
            // éš±è—æ‰€æœ‰å€åŸŸ
            document.getElementById('studio-section').classList.add('hidden');
            document.getElementById('craft-section').classList.add('hidden');
            
            // é¡¯ç¤ºé¸æ“‡çš„å€åŸŸ
            document.getElementById(business + '-section').classList.remove('hidden');
            
            // é¡¯ç¤ºå„€è¡¨æ¿
            switchView(business, 'dashboard');
        }

        // åˆ‡æ›è¦–åœ–
        function switchView(business, view) {
            currentView = view;
            
            // éš±è—æ‰€æœ‰è¦–åœ–
            const viewIds = {
                studio: ['dashboard', 'internal', 'external', 'monthly', 'yearly'],
                craft: ['dashboard', 'internal', 'external', 'inventory', 'monthly', 'yearly']
            };
            
            viewIds[business].forEach(viewId => {
                const element = document.getElementById(business + '-' + viewId);
                if (element) element.classList.add('hidden');
            });
            
            // é¡¯ç¤ºé¸æ“‡çš„è¦–åœ–
            const targetView = document.getElementById(business + '-' + view);
            if (targetView) targetView.classList.remove('hidden');
            
            // æ›´æ–°è³‡æ–™
            updateView(business, view);
        }

        // æ›´æ–°è¦–åœ–è³‡æ–™
        function updateView(business, view) {
            switch (view) {
                case 'dashboard':
                    updateDashboard(business);
                    break;
                case 'internal':
                    updateInternalTable(business);
                    break;
                case 'external':
                    updateExternalTable(business);
                    break;
                case 'inventory':
                    updateInventoryTable();
                    break;
                case 'monthly':
                    initializeMonthSelector(business);
                    updateMonthlyReport(business);
                    break;
                case 'yearly':
                    updateYearlyStats(business);
                    break;
            }
        }

        // åˆ‡æ›è¡¨å–®é¡¯ç¤º
        function toggleForm(formId) {
            const form = document.getElementById(formId);
            if (form) form.classList.toggle('hidden');
        }

        // åˆå§‹åŒ–æœˆä»½é¸æ“‡å™¨
        function initializeMonthSelector(business) {
            const selector = document.getElementById(business + '-month-selector');
            if (!selector) return;
            
            const today = new Date();
            const currentMonth = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0');
            selector.value = currentMonth;
        }

        // æ›´æ–°æœˆå ±è¡¨
function updateMonthlyReport(business) {
    const selector = document.getElementById(business + '-month-selector');
    if (!selector || !selector.value) return;
    
    const [year, month] = selector.value.split('-').map(Number);
    
    // ç¯©é¸è©²æœˆä»½çš„äº¤æ˜“è³‡æ–™
    const allInternalTransactions = businessData[business].internal.filter(t => {
        const date = new Date(t.date);
        return date.getFullYear() === year && date.getMonth() === month - 1;
    });
    
    const allExternalTransactions = businessData[business].external.filter(t => {
        const date = new Date(t.date);
        return date.getFullYear() === year && date.getMonth() === month - 1;
    });
    
    // è¨ˆç®—çµ±è¨ˆæ•¸æ“š
    const internalIncome = allInternalTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
    const internalExpense = allInternalTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
    
    const externalIncome = allExternalTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
    const externalExpense = allExternalTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
    
    // é‡æ–°è¨ˆç®—æ·¨åˆ©ï¼š (æ‰€æœ‰æ”¶å…¥) - (æ‰€æœ‰æ”¯å‡º)
    const profit = internalIncome + externalIncome - internalExpense - externalExpense;
    
    // è¨ˆç®—å…¥å¸³ç‹€æ…‹çµ±è¨ˆ
    const allTransactions = [...allInternalTransactions, ...allExternalTransactions];
    const recordedCount = allTransactions.filter(t => t.accountingStatus === 'recorded').length;
    const pendingCount = allTransactions.filter(t => t.accountingStatus === 'pending').length;
    
    // æ›´æ–°é¡¯ç¤º
    document.getElementById(`${business}-report-internal-income`).textContent = `NT$ ${internalIncome.toLocaleString()}`;
    document.getElementById(`${business}-report-internal-expense`).textContent = `NT$ ${internalExpense.toLocaleString()}`;
    document.getElementById(`${business}-report-income`).textContent = `NT$ ${externalIncome.toLocaleString()}`;
    document.getElementById(`${business}-report-expense`).textContent = `NT$ ${externalExpense.toLocaleString()}`;
    document.getElementById(`${business}-report-profit`).textContent = `NT$ ${profit.toLocaleString()}`;
    document.getElementById(`${business}-report-recorded`).textContent = `${recordedCount} ç­†`;
    document.getElementById(`${business}-report-pending`).textContent = `${pendingCount} ç­†`;
}
            // æ‰‹å·¥è—å“ç‰¹æœ‰çµ±è¨ˆ
            if (business === 'craft') {
                const taiwanYouthSales = monthlyExternal
                    .filter(t => t.type === 'income' && t.brand === 'å°ç£é’å¹´')
                    .reduce((sum, t) => sum + t.amount, 0);
                elements[`${business}-report-taiwan-youth`] = `NT$ ${taiwanYouthSales.toLocaleString()}`;
            }
            
            Object.entries(elements).forEach(([id, text]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = text;
                    if (id.includes('profit')) {
                        element.className = `stat-value ${profit >= 0 ? 'amount-positive' : 'amount-negative'}`;
                    }
                }
            });
            
            // æ›´æ–°äº¤æ˜“æ˜ç´°
            updateMonthlyDetails(business, monthlyInternal, monthlyExternal);
        }

        // æ›´æ–°æœˆåº¦äº¤æ˜“æ˜ç´°
        function updateMonthlyDetails(business, monthlyInternal, monthlyExternal) {
            const container = document.getElementById(business + '-monthly-details');
            if (!container) return;
            
            // åˆä½µä¸¦æ’åºæ‰€æœ‰äº¤æ˜“
            const allTransactions = [
                ...monthlyInternal.map(t => ({...t, category: 'internal'})),
                ...monthlyExternal.map(t => ({...t, category: 'external'}))
            ].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (allTransactions.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 40px;">æœ¬æœˆæš«ç„¡äº¤æ˜“è¨˜éŒ„</p>';
                return;
            }
            
            container.innerHTML = allTransactions.map(t => {
                let typeClass = '';
                let typeLabel = '';
                let amountPrefix = '';
                
                if (t.category === 'internal') {
                    typeClass = 'internal';
                    typeLabel = 'å…§å¸³';
                    amountPrefix = '-';
                } else if (t.type === 'income') {
                    typeClass = 'income';
                    typeLabel = 'å¤–å¸³æ”¶å…¥';
                    amountPrefix = '+';
                } else {
                    typeClass = 'expense';
                    typeLabel = 'å¤–å¸³æ”¯å‡º';
                    amountPrefix = '-';
                }
                
                const brandTag = t.brand === 'å°ç£é’å¹´' ? '<span class="brand-taiwan-youth">å°ç£é’å¹´</span>' : '';
                const invoiceInfo = t.invoiceNumber ? `<span class="invoice-number">${t.invoiceNumber}</span>` : '';
                const statusButton = `<button class="btn btn-toggle ${t.accountingStatus === 'pending' ? 'pending' : ''}" onclick="toggleTransactionStatus('${business}', '${t.category}', ${t.id})" style="padding: 2px 6px; font-size: 10px; margin-left: 4px;">
                    ${t.accountingStatus === 'recorded' ? 'å·²å…¥å¸³' : 'å¾…å…¥å¸³'}
                </button>`;
                
                return `
                    <div class="transaction-item ${typeClass}">
                        <div>
                            <div class="amount-display">${t.description}</div>
                            <div style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 4px;">
                                <span class="tag tag-${typeClass}">${typeLabel}</span>
                                ${t.account} â€¢ ${t.date}
                                ${brandTag}
                                ${invoiceInfo}
                                ${statusButton}
                            </div>
                        </div>
                        <div class="amount-display ${t.type === 'income' ? 'amount-positive' : 'amount-negative'}">
                            ${amountPrefix}NT$ ${t.amount.toLocaleString()}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // åŒ¯å‡ºæœˆå ±è¡¨Excel
        function exportMonthlyToExcel(business) {
            if (typeof XLSX === 'undefined') {
                alert('ExcelåŠŸèƒ½è¼‰å…¥ä¸­ï¼Œè«‹ç¨å¾Œå†è©¦...');
                return;
            }
            
            const selector = document.getElementById(business + '-month-selector');
            if (!selector || !selector.value) return;
            
            const [year, month] = selector.value.split('-').map(Number);
            const monthName = `${year}å¹´${month}æœˆ`;
            
            // ç¯©é¸è©²æœˆä»½çš„è³‡æ–™
            const monthlyInternal = businessData[business].internal.filter(t => {
                const date = new Date(t.date);
                return date.getFullYear() === year && date.getMonth() === month - 1;
            });
            
            const monthlyExternal = businessData[business].external.filter(t => {
                const date = new Date(t.date);
                return date.getFullYear() === year && date.getMonth() === month - 1;
            });
            
            const wb = XLSX.utils.book_new();
            
            // æœˆåº¦å…§å¸³å ±è¡¨
            if (monthlyInternal.length > 0) {
                const internalData = monthlyInternal.map(t => ({
                    'äº¤æ˜“æ—¥æœŸ': t.date,
                    'æœƒè¨ˆç§‘ç›®': t.account,
                    'æ‘˜è¦èªªæ˜': t.description,
                    'é‡‘é¡': t.amount,
                    'ç™¼ç¥¨è™Ÿç¢¼': t.invoiceNumber || '',
                    'ç™¼ç¥¨æ—¥æœŸ': t.invoiceDate || '',
                    'å…¥å¸³ç‹€æ…‹': t.accountingStatus === 'recorded' ? 'å·²å…¥å¸³' : 'å¾…å…¥å¸³'
                }));
                
                const ws1 = XLSX.utils.json_to_sheet(internalData);
                XLSX.utils.book_append_sheet(wb, ws1, `${monthName}å…§å¸³`);
            }
            
            // æœˆåº¦å¤–å¸³å ±è¡¨
            if (monthlyExternal.length > 0) {
                const externalData = monthlyExternal.map(t => {
                    const data = {
                        'äº¤æ˜“æ—¥æœŸ': t.date,
                        'æœƒè¨ˆç§‘ç›®': t.account,
                        'æ‘˜è¦èªªæ˜': t.description,
                        'æ”¶å…¥': t.type === 'income' ? t.amount : '',
                        'æ”¯å‡º': t.type === 'expense' ? t.amount : '',
                        'é¡å‹': t.type === 'income' ? 'ç‡Ÿæ¥­æ”¶å…¥' : 'ç‡Ÿæ¥­æ”¯å‡º',
                        'ç™¼ç¥¨è™Ÿç¢¼': t.invoiceNumber || '',
                        'ç™¼ç¥¨æ—¥æœŸ': t.invoiceDate || '',
                        'å…¥å¸³ç‹€æ…‹': t.accountingStatus === 'recorded' ? 'å·²å…¥å¸³' : 'å¾…å…¥å¸³'
                    };
                    
                    if (business === 'craft') {
                        data['å“ç‰Œ'] = t.brand || '';
                    }
                    
                    return data;
                });
                
                const ws2 = XLSX.utils.json_to_sheet(externalData);
                XLSX.utils.book_append_sheet(wb, ws2, `${monthName}å¤–å¸³`);
            }
            
            const businessName = business === 'studio' ? 'æ”å½±å·¥ä½œå®¤' : 'æ‰‹å·¥è—å“äº‹æ¥­';
            XLSX.writeFile(wb, `${businessName}${monthName}å ±è¡¨_${new Date().toISOString().split('T')[0]}.xlsx`);
            
            alert('æœˆå ±è¡¨Excelæª”æ¡ˆå·²æˆåŠŸåŒ¯å‡ºï¼');
        }
        function toggleForm(formId) {
            const form = document.getElementById(formId);
            if (form) form.classList.toggle('hidden');
        }

        // åˆ‡æ›äº¤æ˜“è¨˜éŒ„çš„å…¥å¸³ç‹€æ…‹
        function toggleTransactionStatus(business, category, id) {
            const transaction = businessData[business][category].find(t => t.id === id);
            if (!transaction) return;
            
            // åˆ‡æ›ç‹€æ…‹
            transaction.accountingStatus = transaction.accountingStatus === 'recorded' ? 'pending' : 'recorded';
            
            // å„²å­˜è³‡æ–™
            saveData();
            
            // æ›´æ–°é¡¯ç¤º
            updateView(business, category);
            if (currentView === 'dashboard') {
                updateDashboard(business);
            }
        }

        // æ›´æ–°å„€è¡¨æ¿
function updateDashboard(business) {
    const currentMonth = new Date().getMonth();
    const currentYear = new Date().getFullYear();
    
    // ç¯©é¸æœ¬æœˆå…§å¸³è³‡æ–™
    const monthlyInternal = businessData[business].internal
        .filter(t => {
            const date = new Date(t.date);
            return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
        });

    const monthlyInternalIncome = monthlyInternal
        .filter(t => t.type === 'income')
        .reduce((sum, t) => sum + t.amount, 0);

    const monthlyInternalExpense = monthlyInternal
        .filter(t => t.type === 'expense')
        .reduce((sum, t) => sum + t.amount, 0);

    // ç¯©é¸æœ¬æœˆå¤–å¸³è³‡æ–™
    const monthlyExternal = businessData[business].external
        .filter(t => {
            const date = new Date(t.date);
            return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
        });
    
    const monthlyExternalIncome = monthlyExternal
        .filter(t => t.type === 'income')
        .reduce((sum, t) => sum + t.amount, 0);
    
    const monthlyExternalExpense = monthlyExternal
        .filter(t => t.type === 'expense')
        .reduce((sum, t) => sum + t.amount, 0);
    
    const monthlyProfit = (monthlyInternalIncome + monthlyExternalIncome) - (monthlyInternalExpense + monthlyExternalExpense);

    // è¨ˆç®—æœ¬æœˆå¾…å…¥å¸³é‡‘é¡
    const pendingAmount = [...monthlyInternal, ...monthlyExternal]
        .filter(t => t.accountingStatus === 'pending')
        .reduce((sum, t) => sum + t.amount, 0);
    
    // æ›´æ–°é¡¯ç¤º
    document.getElementById(`${business}-monthly-internal`).textContent = `NT$ ${monthlyInternalExpense.toLocaleString()}`;
    document.getElementById(`${business}-monthly-external-income`).textContent = `NT$ ${monthlyExternalIncome.toLocaleString()}`;
    document.getElementById(`${business}-monthly-external-expense`).textContent = `NT$ ${monthlyExternalExpense.toLocaleString()}`;
    document.getElementById(`${business}-monthly-profit`).textContent = `NT$ ${monthlyProfit.toLocaleString()}`;
    document.getElementById(`${business}-monthly-pending-amount`).textContent = `NT$ ${pendingAmount.toLocaleString()}`;
    document.getElementById(`${business}-monthly-profit`).className = `stat-value ${monthlyProfit >= 0 ? 'amount-positive' : 'amount-negative'}`;

    // æ›´æ–°æœ€è¿‘äº¤æ˜“è¨˜éŒ„
    updateRecentTransactions(business);
}
            // æ‰‹å·¥è—å“ç‰¹æœ‰çµ±è¨ˆ
            if (business === 'craft') {
                const inventoryValue = businessData.craft.inventory.reduce((sum, item) => 
                    sum + (item.quantity * item.price), 0);
                
                const taiwanYouthValue = businessData.craft.inventory
                    .filter(item => item.brand === 'å°ç£é’å¹´')
                    .reduce((sum, item) => sum + (item.quantity * item.price), 0);
                
                const inventoryElement = document.getElementById('craft-inventory-value');
                const taiwanYouthElement = document.getElementById('craft-taiwan-youth-value');
                
                if (inventoryElement) inventoryElement.textContent = `NT$ ${inventoryValue.toLocaleString()}`;
                if (taiwanYouthElement) taiwanYouthElement.textContent = `NT$ ${taiwanYouthValue.toLocaleString()}`;
            }
            
            // æ›´æ–°æœ€è¿‘äº¤æ˜“
            updateRecentTransactions(business);
        }

        // æ›´æ–°æœ€è¿‘äº¤æ˜“è¨˜éŒ„
        function updateRecentTransactions(business) {
            const container = document.getElementById(business + '-recent-transactions');
            if (!container) return;
            
            // åˆä½µæ‰€æœ‰äº¤æ˜“è¨˜éŒ„
            const allTransactions = [
                ...businessData[business].internal.map(t => ({...t, category: 'internal'})),
                ...businessData[business].external.map(t => ({...t, category: 'external'}))
            ];
            
            const recentTransactions = allTransactions
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5);
            
            container.innerHTML = recentTransactions.map(t => {
                let typeClass = '';
                let typeLabel = '';
                let amountPrefix = '';
                
                if (t.category === 'internal') {
                    typeClass = 'internal';
                    typeLabel = 'å…§å¸³';
                    amountPrefix = '-';
                } else if (t.type === 'income') {
                    typeClass = 'income';
                    typeLabel = 'å¤–å¸³æ”¶å…¥';
                    amountPrefix = '+';
                } else {
                    typeClass = 'expense';
                    typeLabel = 'å¤–å¸³æ”¯å‡º';
                    amountPrefix = '-';
                }
                
                const brandTag = t.brand === 'å°ç£é’å¹´' ? '<span class="brand-taiwan-youth">å°ç£é’å¹´</span>' : '';
                const invoiceInfo = t.invoiceNumber ? `<span class="invoice-number">${t.invoiceNumber}</span>` : '';
                const statusTag = `<button class="btn btn-toggle ${t.accountingStatus === 'pending' ? 'pending' : ''}" onclick="toggleTransactionStatus('${business}', '${t.category}', ${t.id})" style="padding: 2px 6px; font-size: 10px; margin-left: 4px;">
                    ${t.accountingStatus === 'recorded' ? 'å·²å…¥å¸³' : 'å¾…å…¥å¸³'}
                </button>`;
                
                return `
                    <div class="transaction-item ${typeClass}">
                        <div>
                            <div class="amount-display">${t.description}</div>
                            <div style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 4px;">
                                <span class="tag tag-${typeClass}">${typeLabel}</span>
                                ${t.account} â€¢ ${t.date}
                                ${brandTag}
                                ${invoiceInfo}
                                ${statusTag}
                            </div>
                        </div>
                        <div class="amount-display ${t.type === 'income' ? 'amount-positive' : 'amount-negative'}">
                            ${amountPrefix}NT$ ${t.amount.toLocaleString()}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // æ›´æ–°å…§å¸³è¡¨æ ¼
        function updateInternalTable(business) {
            const tbody = document.getElementById(business + '-internal-table');
            if (!tbody) return;
            
            tbody.innerHTML = businessData[business].internal
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .map(t => {
                    const invoiceInfo = t.invoiceNumber ? 
                        `<div class="invoice-info">
                            <span class="invoice-number">${t.invoiceNumber}</span>
                            ${t.invoiceDate ? `<br><small>${t.invoiceDate}</small>` : ''}
                        </div>` : '-';
                    
                    const statusTag = `<button class="btn btn-toggle ${t.accountingStatus === 'pending' ? 'pending' : ''}" onclick="toggleTransactionStatus('${business}', 'internal', ${t.id})" style="padding: 4px 8px; font-size: 11px;">
                        ${t.accountingStatus === 'recorded' ? 'å·²å…¥å¸³' : 'å¾…å…¥å¸³'}
                    </button>`;
                    
                    return `
                        <tr>
                            <td>${t.date}</td>
                            <td><span class="tag tag-internal">${t.account}</span></td>
                            <td>${t.description}</td>
                            <td class="amount-display amount-negative">NT$ ${t.amount.toLocaleString()}</td>
                            <td>${invoiceInfo}</td>
                            <td>${statusTag}</td>
                            <td>
                                <button class="btn btn-coral" onclick="deleteTransaction('${business}', 'internal', ${t.id})" style="padding: 6px 12px; font-size: 12px;">
                                    ğŸ—‘ï¸ åˆªé™¤
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
        }

        // æ›´æ–°å¤–å¸³è¡¨æ ¼
        function updateExternalTable(business) {
            const tbody = document.getElementById(business + '-external-table');
            if (!tbody) return;
            
            tbody.innerHTML = businessData[business].external
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .map(t => {
                    const brandTag = t.brand === 'å°ç£é’å¹´' ? '<span class="brand-taiwan-youth">å°ç£é’å¹´</span>' : (t.brand || '-');
                    const brandColumn = business === 'craft' ? `<td>${brandTag}</td>` : '';
                    
                    const invoiceInfo = t.invoiceNumber ? 
                        `<div class="invoice-info">
                            <span class="invoice-number">${t.invoiceNumber}</span>
                            ${t.invoiceDate ? `<br><small>${t.invoiceDate}</small>` : ''}
                        </div>` : '-';
                    
                    const statusTag = `<button class="btn btn-toggle ${t.accountingStatus === 'pending' ? 'pending' : ''}" onclick="toggleTransactionStatus('${business}', 'external', ${t.id})" style="padding: 4px 8px; font-size: 11px;">
                        ${t.accountingStatus === 'recorded' ? 'å·²å…¥å¸³' : 'å¾…å…¥å¸³'}
                    </button>`;
                    
                    return `
                        <tr>
                            <td>${t.date}</td>
                            <td><span class="tag tag-${t.type}">${t.type === 'income' ? 'æ”¶å…¥' : 'æ”¯å‡º'}</span></td>
                            <td><span class="tag tag-${t.type}">${t.account}</span></td>
                            <td>${t.description}</td>
                            ${brandColumn}
                            <td class="amount-display ${t.type === 'income' ? 'amount-positive' : ''}">
                                ${t.type === 'income' ? `NT$ ${t.amount.toLocaleString()}` : '-'}
                            </td>
                            <td class="amount-display ${t.type === 'expense' ? 'amount-negative' : ''}">
                                ${t.type === 'expense' ? `NT$ ${t.amount.toLocaleString()}` : '-'}
                            </td>
                            <td>${invoiceInfo}</td>
                            <td>${statusTag}</td>
                            <td>
                                <button class="btn btn-coral" onclick="deleteTransaction('${business}', 'external', ${t.id})" style="padding: 6px 12px; font-size: 12px;">
                                    ğŸ—‘ï¸ åˆªé™¤
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
        }

        // æ›´æ–°åº«å­˜è¡¨æ ¼
        function updateInventoryTable() {
            const tbody = document.getElementById('craft-inventory-table');
            if (!tbody) return;
            
            tbody.innerHTML = businessData.craft.inventory.map(item => {
                const inventoryValue = item.cost * item.quantity;
                const brandTag = item.brand === 'å°ç£é’å¹´' ? '<span class="brand-taiwan-youth">å°ç£é’å¹´</span>' : (item.brand || '-');
                
                return `
                    <tr>
                        <td>${brandTag}</td>
                        <td>${item.category}</td>
                        <td>${item.name}</td>
                        <td>NT$ ${item.cost.toLocaleString()}</td>
                        <td>NT$ ${item.price.toLocaleString()}</td>
                        <td>${item.quantity}</td>
                        <td>NT$ ${inventoryValue.toLocaleString()}</td>
                        <td>${item.notes || '-'}</td>
                        <td>
                            <button class="btn btn-coral" onclick="deleteInventory(${item.id})" style="padding: 6px 12px; font-size: 12px;">
                                ğŸ—‘ï¸ åˆªé™¤
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // æ›´æ–°å¹´åº¦çµ±è¨ˆ
function updateYearlyStats(business) {
    const currentYear = new Date().getFullYear();
    
    // ç¯©é¸æœ¬å¹´åº¦æ‰€æœ‰å…§å¸³è³‡æ–™
    const yearlyInternal = businessData[business].internal
        .filter(t => new Date(t.date).getFullYear() === currentYear);

    const yearlyInternalIncome = yearlyInternal
        .filter(t => t.type === 'income')
        .reduce((sum, t) => sum + t.amount, 0);
    
    const yearlyInternalExpense = yearlyInternal
        .filter(t => t.type === 'expense')
        .reduce((sum, t) => sum + t.amount, 0);
    
    // ç¯©é¸æœ¬å¹´åº¦æ‰€æœ‰å¤–å¸³è³‡æ–™
    const yearlyExternal = businessData[business].external
        .filter(t => new Date(t.date).getFullYear() === currentYear);
    
    const yearlyExternalIncome = yearlyExternal
        .filter(t => t.type === 'income')
        .reduce((sum, t) => sum + t.amount, 0);
    
    const yearlyExternalExpense = yearlyExternal
        .filter(t => t.type === 'expense')
        .reduce((sum, t) => sum + t.amount, 0);
    
    // è¨ˆç®—å¹´åº¦æ·¨åˆ©
    const yearlyProfit = (yearlyInternalIncome + yearlyExternalIncome) - (yearlyInternalExpense + yearlyExternalExpense);
    
    // è¨ˆç®—å¹´åº¦å¾…å…¥å¸³é‡‘é¡
    const yearlyPending = [
        ...yearlyInternal.filter(t => t.accountingStatus === 'pending'),
        ...yearlyExternal.filter(t => t.accountingStatus === 'pending')
    ].reduce((sum, t) => sum + t.amount, 0);
    
    // æ›´æ–°çµ±è¨ˆé¡¯ç¤º
    const elements = {
        [`${business}-yearly-external-income`]: `NT$ ${yearlyExternalIncome.toLocaleString()}`,
        [`${business}-yearly-external-expense`]: `NT$ ${yearlyExternalExpense.toLocaleString()}`,
        [`${business}-yearly-internal-income`]: `NT$ ${yearlyInternalIncome.toLocaleString()}`,
        [`${business}-yearly-internal-expense`]: `NT$ ${yearlyInternalExpense.toLocaleString()}`,
        [`${business}-yearly-profit`]: `NT$ ${yearlyProfit.toLocaleString()}`,
        [`${business}-yearly-pending`]: `NT$ ${yearlyPending.toLocaleString()}`
    };
    
    Object.entries(elements).forEach(([id, text]) => {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = text;
            if (id.includes('profit')) {
                element.className = `stat-value ${yearlyProfit >= 0 ? 'amount-positive' : 'amount-negative'}`;
            }
        }
    });
}
            
            // æ‰‹å·¥è—å“ç‰¹æœ‰çµ±è¨ˆ
            if (business === 'craft') {
                const taiwanYouthSales = yearlyExternal
                    .filter(t => t.type === 'income' && t.brand === 'å°ç£é’å¹´')
                    .reduce((sum, t) => sum + t.amount, 0);
                
                const salesElement = document.getElementById('craft-taiwan-youth-sales');
                if (salesElement) salesElement.textContent = `NT$ ${taiwanYouthSales.toLocaleString()}`;
            }
        }

        // æ–°å¢äº¤æ˜“è¨˜éŒ„
function addTransaction(business, category) {
    const prefix = business + '-' + category;
    const type = document.getElementById(prefix + '-type').value; // å°‡é¡å‹è®€å–ç§»åˆ°é€™è£¡
    const account = document.getElementById(prefix + '-account').value;
    const amount = parseFloat(document.getElementById(prefix + '-amount').value);
    const description = document.getElementById(prefix + '-description').value;
    const date = document.getElementById(prefix + '-date').value;
    const invoiceNumber = document.getElementById(prefix + '-invoice').value;
    const invoiceDate = document.getElementById(prefix + '-invoice-date').value;

    let brand = '';

    // é€™æ®µè™•ç†åªé‡å°æ‰‹å·¥è—å“å¤–å¸³çš„å“ç‰Œæ¬„ä½
    if (business === 'craft' && category === 'external') {
        const brandElement = document.getElementById(prefix + '-brand');
        if (brandElement) brand = brandElement.value;
    }

    if (!account || !amount || !description || !date) {
        alert('è«‹å¡«å¯«æ‰€æœ‰å¿…è¦æ¬„ä½');
        return;
    }

    const newTransaction = {
        id: Date.now(),
        account,
        amount,
        description,
        date,
        invoiceNumber: invoiceNumber || '',
        invoiceDate: invoiceDate || '',
        accountingStatus: currentAccountingStatus[prefix],
        type // æ–°å¢ï¼šå°‡é¡å‹å„²å­˜åˆ°äº¤æ˜“è¨˜éŒ„ä¸­
    };

    if (business === 'craft' && category === 'external') {
        newTransaction.brand = brand;
    }

    businessData[business][category].push(newTransaction);
    saveData();

    // æ¸…ç©ºè¡¨å–®
    document.getElementById(prefix + '-account').value = '';
    document.getElementById(prefix + '-amount').value = '';
    document.getElementById(prefix + '-description').value = '';
    document.getElementById(prefix + '-invoice').value = '';
    document.getElementById(prefix + '-invoice-date').value = '';
    document.getElementById(prefix + '-type').value = 'expense'; // ä¿®æ­£ï¼šæ¸…ç©ºæ™‚é è¨­ç‚ºæ”¯å‡º
    document.getElementById(prefix + '-date').value = ''; // æ–°å¢ï¼šæ¸…ç©ºæ—¥æœŸ
    
    // å¦‚æœæ˜¯æ‰‹å·¥è—å“äº‹æ¥­çš„å¤–å¸³ï¼Œä¹Ÿæ¸…ç©ºå“ç‰Œ
    if (business === 'craft' && category === 'external') {
        const brandElement = document.getElementById(prefix + '-brand');
        if (brandElement) brandElement.value = '';
    }

    // é‡ç½®å…¥å¸³ç‹€æ…‹æŒ‰éˆ•
    const toggleBtn = document.getElementById(prefix + '-status-toggle');
    const textSpan = document.getElementById(prefix + '-status-text');
    if (toggleBtn && textSpan) {
        toggleBtn.classList.remove('pending');
        textSpan.textContent = 'å·²å…¥å¸³';
        currentAccountingStatus[prefix] = 'recorded';
    }

    // éš±è—è¡¨å–®
    const formElement = document.getElementById(prefix + '-form');
    if (formElement) formElement.classList.add('hidden');

    // æ›´æ–°é¡¯ç¤º
    updateView(business, category);

    // å¦‚æœåœ¨å„€è¡¨æ¿ï¼Œä¹Ÿè¦æ›´æ–°å„€è¡¨æ¿
    if (currentView === 'dashboard') {
        updateDashboard(business);
    }
}

        // æ–°å¢åº«å­˜å•†å“
        function addInventoryItem() {
            const name = document.getElementById('inventory-name').value;
            const category = document.getElementById('inventory-category').value;
            const quantity = parseInt(document.getElementById('inventory-quantity').value);
            const cost = parseFloat(document.getElementById('inventory-cost').value);
            const price = parseFloat(document.getElementById('inventory-price').value);
            const brand = document.getElementById('inventory-brand').value;
            const notes = document.getElementById('inventory-notes').value;
            
            if (!name || !category || !quantity || !cost || !price) {
                alert('è«‹å¡«å¯«æ‰€æœ‰å¿…è¦æ¬„ä½');
                return;
            }
            
            const newItem = {
                id: Date.now(),
                name,
                category,
                quantity,
                cost,
                price,
                brand,
                notes
            };
            
            businessData.craft.inventory.push(newItem);
            saveData();
            
            // æ¸…ç©ºè¡¨å–®
            document.getElementById('inventory-name').value = '';
            document.getElementById('inventory-category').value = '';
            document.getElementById('inventory-quantity').value = '';
            document.getElementById('inventory-cost').value = '';
            document.getElementById('inventory-price').value = '';
            document.getElementById('inventory-brand').value = '';
            document.getElementById('inventory-notes').value = '';
            
            // éš±è—è¡¨å–®
            const formElement = document.getElementById('inventory-form');
            if (formElement) formElement.classList.add('hidden');
            
            // æ›´æ–°é¡¯ç¤º
            updateInventoryTable();
            if (currentView === 'dashboard') {
                updateDashboard('craft');
            }
        }

        // åˆªé™¤äº¤æ˜“è¨˜éŒ„
        function deleteTransaction(business, category, id) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜éŒ„å—ï¼Ÿ')) return;
            
            businessData[business][category] = businessData[business][category].filter(t => t.id !== id);
            saveData();
            
            // æ›´æ–°é¡¯ç¤º
            updateView(business, category);
            if (currentView === 'dashboard') {
                updateDashboard(business);
            }
        }

        // åˆªé™¤åº«å­˜å•†å“
        function deleteInventory(id) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹å•†å“å—ï¼Ÿ')) return;
            
            businessData.craft.inventory = businessData.craft.inventory.filter(item => item.id !== id);
            saveData();
            
            // æ›´æ–°é¡¯ç¤º
            updateInventoryTable();
            if (currentView === 'dashboard') {
                updateDashboard('craft');
            }
        }

        // æ¸…é™¤æ‰€æœ‰è³‡æ–™
        function clearAllData() {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
                if (confirm('æœ€å¾Œç¢ºèªï¼šé€™å°‡åˆªé™¤æ‰€æœ‰äº¤æ˜“è¨˜éŒ„å’Œåº«å­˜è³‡æ–™ï¼')) {
                    localStorage.removeItem('businessData');
                    
                    businessData = {
                        studio: {
                            internal: [],
                            external: []
                        },
                        craft: {
                            internal: [],
                            external: [],
                            inventory: []
                        }
                    };
                    
                    saveData();
                    
                    // é‡æ–°è¼‰å…¥ç•¶å‰è¦–åœ–
                    if (currentBusiness && currentView) {
                        updateView(currentBusiness, currentView);
                    }
                    
                    alert('æ‰€æœ‰è³‡æ–™å·²æ¸…é™¤ï¼');
                }
            }
        }

        // åŒ¯å‡ºExcelåŠŸèƒ½
        function exportToExcel(business) {
            if (typeof XLSX === 'undefined') {
                alert('ExcelåŠŸèƒ½è¼‰å…¥ä¸­ï¼Œè«‹ç¨å¾Œå†è©¦...');
                return;
            }

            const wb = XLSX.utils.book_new();
            
            // å…§å¸³å ±è¡¨
            const internalData = businessData[business].internal.map(t => ({
                'äº¤æ˜“æ—¥æœŸ': t.date,
                'æœƒè¨ˆç§‘ç›®': t.account,
                'æ‘˜è¦èªªæ˜': t.description,
                'é‡‘é¡': t.amount,
                'ç™¼ç¥¨è™Ÿç¢¼': t.invoiceNumber || '',
                'ç™¼ç¥¨æ—¥æœŸ': t.invoiceDate || '',
                'å…¥å¸³ç‹€æ…‹': t.accountingStatus === 'recorded' ? 'å·²å…¥å¸³' : 'å¾…å…¥å¸³'
            }));
            
            const ws1 = XLSX.utils.json_to_sheet(internalData);
            XLSX.utils.book_append_sheet(wb, ws1, 'å…§å¸³è¨˜éŒ„');
            
            // å¤–å¸³å ±è¡¨
            const externalData = businessData[business].external.map(t => {
                const data = {
                    'äº¤æ˜“æ—¥æœŸ': t.date,
                    'æœƒè¨ˆç§‘ç›®': t.account,
                    'æ‘˜è¦èªªæ˜': t.description,
                    'æ”¶å…¥': t.type === 'income' ? t.amount : '',
                    'æ”¯å‡º': t.type === 'expense' ? t.amount : '',
                    'é¡å‹': t.type === 'income' ? 'ç‡Ÿæ¥­æ”¶å…¥' : 'ç‡Ÿæ¥­æ”¯å‡º',
                    'ç™¼ç¥¨è™Ÿç¢¼': t.invoiceNumber || '',
                    'ç™¼ç¥¨æ—¥æœŸ': t.invoiceDate || '',
                    'å…¥å¸³ç‹€æ…‹': t.accountingStatus === 'recorded' ? 'å·²å…¥å¸³' : 'å¾…å…¥å¸³'
                };
                
                if (business === 'craft') {
                    data['å“ç‰Œ'] = t.brand || '';
                }
                
                return data;
            });
            
            const ws2 = XLSX.utils.json_to_sheet(externalData);
            XLSX.utils.book_append_sheet(wb, ws2, 'å¤–å¸³è¨˜éŒ„');
            
            // æ‰‹å·¥è—å“ç‰¹æœ‰ï¼šåº«å­˜å ±è¡¨
            if (business === 'craft') {
                const inventoryData = businessData.craft.inventory.map(item => ({
                    'å“ç‰Œ': item.brand || '',
                    'å•†å“åˆ†é¡': item.category,
                    'å•†å“åç¨±': item.name,
                    'åº«å­˜æ•¸é‡': item.quantity,
                    'å–®ä½æˆæœ¬': item.cost,
                    'å–®ä½å”®åƒ¹': item.price,
                    'ç¸½æˆæœ¬': item.quantity * item.cost,
                    'ç¸½åƒ¹å€¼': item.quantity * item.price,
                    'æ¯›åˆ©ç‡': `${((item.price - item.cost) / item.price * 100).toFixed(1)}%`,
                    'å‚™è¨»': item.notes || ''
                }));
                
                const ws3 = XLSX.utils.json_to_sheet(inventoryData);
                XLSX.utils.book_append_sheet(wb, ws3, 'åº«å­˜å ±è¡¨');
            }
            
            const businessName = business === 'studio' ? 'æ”å½±å·¥ä½œå®¤' : 'æ‰‹å·¥è—å“äº‹æ¥­';
            XLSX.writeFile(wb, `${businessName}å ±è¡¨_${new Date().toISOString().split('T')[0]}.xlsx`);
            
            alert('Excelæª”æ¡ˆå·²æˆåŠŸåŒ¯å‡ºï¼');
        }
    </script>
</body>
</html>